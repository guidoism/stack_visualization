<style type="text/css" media="screen">
 @font-face{font-family:a;src:url(Apl385.woff)format('woff');}
 body,textarea,input,button{font-family:a,monospace;}
 table {font-size: 12px}
 a{color:#008;text-decoration:none}
 a:hover{text-decoration:underline}
 table { border-collapse: collapse }
 td { vertical-align: bottom; align: right }
 td { border: 1px solid black; width: 10em; }
 .hidden { border: none }
</style>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>

<table>
    <tr>
	<td class="hidden"><table id="return"></table></td>
	<td class="hidden"><table id="data"></table></td>
	<td class="hidden"><table id="words"></table></td>
    </tr>
    <tr><td id="program" colspan="3"></td></tr>
</table>

<script>
 $(document).ready(function() {
     var data = [0, 1, 2, 5, 7, 9]
     var program = []
     function* pop(n) { for (n; n>0; n--) yield data.pop() }
     const push = list => { data = data.concat(list) }
     
     function update() {
	 var t = d3.select("#data").selectAll("td").data(data).text(function(d) { return d; });
	 t.enter().append("tr").append("td").text(function(d) { return d; });
	 t.exit().remove();

     	 t = d3.select("#program").selectAll("td").data(program).text(function(d) { return d; });
	 t.enter().append("td").text(function(d) { return d; });
	 t.exit().remove();
     }
     
     $('#return').append('<tr><td>0x01</td></tr>');

     let words = [
 	 ['DROP', () => {
	     data.pop()
	 }],
	 ['SWAP', () => {
	     let [b, a] = pop(2)
	     push([b, a])
	 }],
	 ['DUP', () => {
	     data.push(data[data.length-1])
	 }],
	 ['OVER', () => {
	     data.push(data[data.length-2])
	 }],
	 ['ROT', () => {
	     let [c, b, a] = pop(3)
	     push([b, c, a])
	 }],
	 ['-ROT', () => {
	     let [c, b, a] = pop(3)
	     push([c, a, b])
	 }],
	 ['2DROP', () => {
	     let [b, a] = pop(2)
	 }],
	 ['2DUP', () => {
	     push([data[data.length-2], data[data.length-1]])
	 }],
	 ['2SWAP', () => {
	     let [d, c, b, a] = pop(4)
	     push([c, d, a, b])
	 }],
	 ['?DUP', () => {
	     let a = data[data.length-1]
	     if (a != 0) data.push(a)
	 }],
	 ['1+', () => {
	     push([data.pop()+1])
	 }],
	 ['1-', () => {
	     push([data.pop()-1])
	 }],
	 ['4+', () => {
	     push([data.pop()+4])
	 }],
	 ['4-', () => {
	     push([data.pop()-4])
	 }],
	 ['+', () => {
	     let [b, a] = pop(2)
	     push([b+a])
	 }],
	 ['-', () => {
	     let [b, a] = pop(2)
	     push([a-b])
	 }],
	 ['*', () => {
	     let [b, a] = pop(2)
	     push([a*b])
	 }],
	 ['/MOD', () => {
	     let [a, b] = pop(2)
	     push([b % a, Math.trunc(b/a)])
	 }],
     ]

     words.map(tuple => {
	 let [w, f] = tuple
	 $('#words').append($(`<tr><td class="hidden"><button>${w}</button></td></tr>`).click(() => {
	     f()
	     program.push(w)
	     update()
	 }))
     })

     update()
 })
</script>
